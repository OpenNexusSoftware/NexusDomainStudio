{
    "id": "change_role",
    "name": "ChangeRole",
    "description": "Change the role of the user account",
    "preconditions": [
        { "allowedTransition": { "property": "role", "to": "$args.newRole", "onFailure": { "raise": "InvalidRoleTransitionException", "message": "Cannot change role to $args.newRole from $this.role" } } }
    ],
    "args": [
        { "name": "newRole", "type": "UserRole", "description": "New role for the user account", "required": true }
    ],
    "noOpWhen": [
        { "equals": { "left": "$this.role", "right": "$args.newRole" } }
    ],
    "post": [
        { "property": "role", "value": "$args.newRole" },
        { "property": "updatedAt", "value": "dateTime.now" }
    ],
    "emits": [
        { 
            "event": "UserRoleChanged", 
            "description": "Emits when a user's role changes",
            "maps": [
                { "property": "userId", "value": "$this.id" },
                { "property": "oldRole", "value": "$prev.role" },
                { "property": "newRole", "value": "$this.role" },
                { "property": "changedAt", "value": "$this.updatedAt" }
            ]
        },
        {
            "event": "UserAccountUpdated",
            "description": "Emits when a user account is updated after role change",
            "maps": [
              { "property": "userId", "value": "$this.id" },
              { "property": "updatedAt", "value": "$this.updatedAt" }
            ]
        }
    ]
}